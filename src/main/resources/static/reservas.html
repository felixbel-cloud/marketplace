<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservas</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">Market</div>
    <nav class="nav-links">
      <a href="index.html">Inicio</a>
      <a href="producto_nuevo.html" id="publicar-link">Publicar producto</a>
      <a href="reservas.html" aria-current="page" id="reservas-link">Mis reservas</a>
      <a href="panel_negocio.html" id="panel-link">Panel negocio</a>
      <span class="nav-user" id="nav-user" hidden></span>
      <a href="login.html" id="login-link">Log in</a>
      <a href="register.html" id="register-link">Register</a>
      <button type="button" class="logout-button" id="logout-button" hidden>
        Cerrar sesión
      </button>
    </nav>
  </header>

  <main class="main">
    <section class="hero">
      <h1>Gestiona tus reservas</h1>
      <p>Registra nuevas reservas y consulta el historial de forma rápida.</p>
    </section>

    <section class="layout">
      <section class="offers surface">
        <div class="section-header">
          <div>
            <h2>Nueva reserva</h2>
            <p class="helper-text">Registra rápidamente una nueva reserva de cliente.</p>
          </div>
        </div>

        <form id="reservation-form" class="form-shell">
          <div class="grid-responsive">
            <label class="input-stack">
              <span>ID del cliente</span>
              <input type="number" name="idCliente" min="1" step="1" required placeholder="Ej. 12" />
            </label>

            <label class="input-stack">
              <span>ID del producto</span>
              <input type="number" name="idProducto" min="1" step="1" required placeholder="Ej. 34" />
            </label>

            <label class="input-stack">
              <span>Cantidad</span>
              <input type="number" name="cantidad" min="1" step="1" required placeholder="Ej. 2" />
            </label>
          </div>

          <p class="helper-text">La fecha se asignará automáticamente al día actual.</p>
          <div class="section-actions">
            <button type="submit" class="primary-button" id="submit-reservation">Registrar reserva</button>
            <div id="form-status" class="helper-text" role="alert" aria-live="polite"></div>
          </div>
        </form>
      </section>

      <section class="offers surface">
        <div class="section-header">
          <div>
            <h2>Reservas registradas</h2>
            <p class="helper-text">Filtra por cliente o revisa el historial completo.</p>
          </div>
          <div class="search-bar inline">
            <input type="number" id="idClienteFiltro" min="1" step="1" placeholder="ID cliente" />
            <button type="button" class="primary-button" id="filter-button">Filtrar</button>
            <button type="button" id="reset-button" class="primary-button">Ver todas</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="table-simple">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody id="reservations-body">
              <tr>
                <td colspan="5" class="meta">Cargando reservas...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const navUser = document.getElementById("nav-user");
      const loginLink = document.getElementById("login-link");
      const registerLink = document.getElementById("register-link");
      const logoutButton = document.getElementById("logout-button");

      const form = document.getElementById("reservation-form");
      const formStatus = document.getElementById("form-status");
      const submitButton = document.getElementById("submit-reservation");
      const reservationsBody = document.getElementById("reservations-body");
      const filterInput = document.getElementById("idClienteFiltro");
      const filterButton = document.getElementById("filter-button");
      const resetButton = document.getElementById("reset-button");

      const API_BASE_URL = "http://localhost:8084/api/reservas";

      // Recupera datos básicos de sesión desde localStorage
      function loadCurrentUser() {
        const stored = localStorage.getItem("usuarioActual");
        if (!stored) return null;
        try {
          const parsed = JSON.parse(stored);
          if (parsed && (parsed.id || parsed.idUsuario) && parsed.nombre) {
            return parsed;
          }
        } catch (error) {
          return null;
        }
        return null;
      }

      // Actualiza el header según haya usuario activo
      function renderSession() {
        const currentUser = loadCurrentUser();
        const reservasLink = document.getElementById("reservas-link");
        const panelLink = document.getElementById("panel-link");
        const publicarLink = document.getElementById("publicar-link");

        if (currentUser) {
          navUser.textContent = `Hola, ${currentUser.nombre}`;
          navUser.hidden = false;
          logoutButton.hidden = false;
          loginLink.hidden = true;
          registerLink.hidden = true;

          if (currentUser.rol === "NEGOCIO") {
            reservasLink.hidden = true;
            panelLink.hidden = false;
            publicarLink.hidden = false;
          } else {
            reservasLink.hidden = false;
            panelLink.hidden = true;
            publicarLink.hidden = true;
          }
        } else {
          navUser.hidden = true;
          logoutButton.hidden = true;
          loginLink.hidden = false;
          registerLink.hidden = false;
          reservasLink.hidden = true;
          panelLink.hidden = true;
          publicarLink.hidden = true;
        }
      }

      logoutButton?.addEventListener("click", () => {
        localStorage.removeItem("usuarioActual");
        window.location.href = "index.html";
      });

      renderSession();

      // Muestra el estado del envío del formulario de reserva
      function setStatus(text, isError = false) {
        formStatus.textContent = text;
        formStatus.style.color = isError ? "#b00020" : "#0f5132";
      }

      // Formatea la fecha de reserva para la tabla
      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        if (Number.isNaN(date.getTime())) return dateString;
        return date.toLocaleDateString("es-PE", { year: "numeric", month: "short", day: "numeric" });
      }

      // Renderiza las filas de reservas obtenidas
      function renderReservations(reservations) {
        reservationsBody.innerHTML = "";

        if (!reservations.length) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.style.padding = "12px";
          cell.style.color = "#6b7280";
          cell.textContent = "No hay reservas registradas.";
          row.appendChild(cell);
          reservationsBody.appendChild(row);
          return;
        }

        reservations.forEach((reservation) => {
          const row = document.createElement("tr");
          const cells = [
            reservation.id,
            reservation.idCliente,
            reservation.idProducto,
            reservation.cantidad,
            formatDate(reservation.fechaReserva),
          ];

          cells.forEach((value) => {
            const cell = document.createElement("td");
            cell.style.padding = "8px";
            cell.textContent = value ?? "-";
            row.appendChild(cell);
          });

          reservationsBody.appendChild(row);
        });
      }

      // Carga reservas desde la API y permite filtros
      async function fetchReservations(url = API_BASE_URL) {
        reservationsBody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 12px; color: #6b7280;">Cargando reservas...</td>
          </tr>
        `;

        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error();
          const data = await response.json();
          const list = Array.isArray(data) ? data : [];
          renderReservations(list);
        } catch (error) {
          reservationsBody.innerHTML = `
            <tr>
              <td colspan="5" style="padding: 12px; color: #b00020;">No fue posible obtener las reservas.</td>
            </tr>
          `;
        }
      }

      // Envía el formulario para crear una nueva reserva
      async function handleSubmit(event) {
        event.preventDefault();
        setStatus("");
        submitButton.disabled = true;

        const formData = new FormData(form);
        const today = new Date().toISOString().split("T")[0];
        const payload = {
          idCliente: parseInt(formData.get("idCliente"), 10) || null,
          idProducto: parseInt(formData.get("idProducto"), 10) || null,
          cantidad: parseInt(formData.get("cantidad"), 10) || 1,
          fechaReserva: today,
        };

        try {
          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "No se pudo registrar la reserva.");
          }

          setStatus("Reserva registrada correctamente.");
          form.reset();
          fetchReservations();
        } catch (error) {
          setStatus("No pudimos registrar la reserva. Intenta nuevamente.", true);
        } finally {
          submitButton.disabled = false;
        }
      }

      // Aplica el filtro por ID de cliente cuando corresponde
      function handleFilter() {
        const idCliente = filterInput.value.trim();
        if (!idCliente) {
          fetchReservations();
          return;
        }
        const url = `${API_BASE_URL}/cliente/${encodeURIComponent(idCliente)}`;
        fetchReservations(url);
      }

      form.addEventListener("submit", handleSubmit);
      filterButton.addEventListener("click", handleFilter);
      resetButton.addEventListener("click", () => {
        filterInput.value = "";
        fetchReservations();
      });

      fetchReservations();
    });
  </script>
</body>
</html>
