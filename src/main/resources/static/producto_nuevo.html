<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar producto</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">Market</div>
    <nav class="nav-links">
      <a href="index.html">Inicio</a>
      <a href="producto_nuevo.html" aria-current="page" id="publicar-link">Publicar producto</a>
      <a href="reservas.html" id="reservas-link">Mis reservas</a>
      <a href="panel_negocio.html" id="panel-link">Panel negocio</a>
      <span class="nav-user" id="nav-user" hidden></span>
      <a href="login.html" id="login-link">Log in</a>
      <a href="register.html" id="register-link">Register</a>
      <button type="button" class="logout-button" id="logout-button" hidden>
        Cerrar sesión
      </button>
    </nav>
  </header>

  <main class="main">
    <section class="hero">
      <h1>Publica un nuevo producto</h1>
      <p>Registra la información del producto para que los clientes puedan encontrarlo.</p>
    </section>

    <section class="layout">
      <section class="offers surface">
        <div class="section-header">
          <div>
            <h2>Formulario de registro</h2>
            <p class="helper-text">Completa la información del producto antes de publicarlo.</p>
          </div>
        </div>

        <form id="product-form" class="form-shell">
          <label class="input-stack">
            <span>Nombre</span>
            <input type="text" name="nombre" required placeholder="Nombre del producto" />
          </label>

          <label class="input-stack">
            <span>Categoría</span>
            <select name="categoria" required>
              <option value="">Seleccione una categoría</option>
              <option value="Alimentos">Alimentos</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Lácteos">Lácteos</option>
              <option value="Snacks">Snacks</option>
            </select>
          </label>

          <label class="input-stack">
            <span>Descripción</span>
            <textarea name="descripcion" rows="3" placeholder="Describe el producto"></textarea>
          </label>

          <div class="grid-responsive">
            <label class="input-stack">
              <span>Precio original</span>
              <input type="number" name="precioOriginal" min="0" step="0.01" required placeholder="0.00" />
            </label>

            <label class="input-stack">
              <span>Precio con descuento</span>
              <input type="number" name="precioDescuento" min="0" step="0.01" placeholder="0.00" />
            </label>

            <label class="input-stack">
              <span>Stock</span>
              <input type="number" name="stock" min="0" step="1" required placeholder="Cantidad disponible" />
            </label>

            <label class="input-stack">
              <span>Fecha de vencimiento</span>
              <input type="date" name="fechaVencimiento" />
            </label>

            <label class="input-stack">
              <span>ID del negocio</span>
              <input type="number" name="idNegocio" min="1" step="1" required placeholder="Ej. 123" />
            </label>
          </div>

          <div class="section-actions">
            <button type="submit" class="primary-button" id="submit-button">Registrar producto</button>
            <div id="form-message" class="helper-text" role="alert" aria-live="polite"></div>
          </div>
        </form>
      </section>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const navUser = document.getElementById("nav-user");
      const loginLink = document.getElementById("login-link");
      const registerLink = document.getElementById("register-link");
      const logoutButton = document.getElementById("logout-button");

      const form = document.getElementById("product-form");
      const message = document.getElementById("form-message");
      const submitButton = document.getElementById("submit-button");
      const API_URL = "http://localhost:8084/api/productos";

      // Recupera la sesión almacenada en localStorage
      function loadCurrentUser() {
        const stored = localStorage.getItem("usuarioActual");
        if (!stored) return null;
        try {
          const parsed = JSON.parse(stored);
          if (parsed && (parsed.id || parsed.idUsuario) && parsed.nombre) {
            return parsed;
          }
        } catch (error) {
          return null;
        }
        return null;
      }

      // Ajusta la cabecera según el estado de la sesión
      function renderSession() {
        const currentUser = loadCurrentUser();
        const reservasLink = document.getElementById("reservas-link");
        const panelLink = document.getElementById("panel-link");
        const publicarLink = document.getElementById("publicar-link");

        if (currentUser) {
          navUser.textContent = `Hola, ${currentUser.nombre}`;
          navUser.hidden = false;
          logoutButton.hidden = false;
          loginLink.hidden = true;
          registerLink.hidden = true;

          if (currentUser.rol === "NEGOCIO") {
            reservasLink.hidden = true;
            panelLink.hidden = false;
            publicarLink.hidden = false;
          } else {
            reservasLink.hidden = false;
            panelLink.hidden = true;
            publicarLink.hidden = true;
          }
        } else {
          navUser.hidden = true;
          logoutButton.hidden = true;
          loginLink.hidden = false;
          registerLink.hidden = false;
          reservasLink.hidden = true;
          panelLink.hidden = true;
          publicarLink.hidden = true;
        }
      }

      logoutButton?.addEventListener("click", () => {
        localStorage.removeItem("usuarioActual");
        window.location.href = "index.html";
      });

      renderSession();

      // Informa brevemente el estado del envío del formulario
      function setStatus(text, isError = false) {
        message.textContent = text;
        message.style.color = isError ? "#b00020" : "#0f5132";
      }

      // Envía el formulario para registrar el producto
      async function handleSubmit(event) {
        event.preventDefault();
        setStatus("");
        submitButton.disabled = true;

        const formData = new FormData(form);
        const payload = {
          nombre: formData.get("nombre")?.trim(),
          categoria: formData.get("categoria") || "",
          descripcion: formData.get("descripcion")?.trim() || "",
          precioOriginal: parseFloat(formData.get("precioOriginal")) || 0,
          precioDescuento: formData.get("precioDescuento") ? parseFloat(formData.get("precioDescuento")) : null,
          stock: parseInt(formData.get("stock"), 10) || 0,
          fechaVencimiento: formData.get("fechaVencimiento") || null,
          idNegocio: parseInt(formData.get("idNegocio"), 10) || null,
        };

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "No se pudo registrar el producto.");
          }

          setStatus("Producto registrado exitosamente. ");
          const backLink = document.createElement("a");
          backLink.href = "index.html";
          backLink.textContent = "Volver al inicio";
          backLink.style.marginLeft = "6px";
          message.appendChild(backLink);
          form.reset();
        } catch (error) {
          setStatus(
            "No pudimos registrar el producto en este momento. Intenta nuevamente.",
            true
          );
        } finally {
          submitButton.disabled = false;
        }
      }

      form.addEventListener("submit", handleSubmit);
    });
  </script>
</body>
</html>
