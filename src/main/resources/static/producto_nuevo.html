<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar producto</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">Market</div>
    <nav class="nav-links">
      <a href="index.html">Inicio</a>
      <a href="#" aria-disabled="true">Log in</a>
      <a href="#" aria-disabled="true">Register</a>
    </nav>
  </header>

  <main class="main">
    <section class="hero">
      <h1>Publica un nuevo producto</h1>
      <p>Registra la información del producto para que los clientes puedan encontrarlo.</p>
    </section>

    <section class="layout">
      <section class="offers" style="width: 100%;">
        <h2>Formulario de registro</h2>
        <form id="product-form" class="card" style="gap: 12px;">
          <label class="filter-option" style="flex-direction: column; align-items: flex-start; gap: 6px;">
            <span>Nombre</span>
            <input type="text" name="nombre" required placeholder="Nombre del producto" />
          </label>

          <label class="filter-option" style="flex-direction: column; align-items: flex-start; gap: 6px;">
            <span>Categoría</span>
            <select name="categoria" required>
              <option value="">Seleccione una categoría</option>
              <option value="Alimentos">Alimentos</option>
              <option value="Bebidas">Bebidas</option>
              <option value="Lácteos">Lácteos</option>
              <option value="Snacks">Snacks</option>
            </select>
          </label>

          <label class="filter-option" style="flex-direction: column; align-items: flex-start; gap: 6px;">
            <span>Descripción</span>
            <textarea name="descripcion" rows="3" placeholder="Describe el producto"></textarea>
          </label>

          <div class="filters" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); display: grid; gap: 12px; align-items: stretch;">
            <label class="filter-option" style="flex-direction: column; align-items: flex-start; gap: 6px;">
              <span>Precio original</span>
              <input type="number" name="precioOriginal" min="0" step="0.01" required placeholder="0.00" />
            </label>

            <label class="filter-option" style="flex-direction: column; align-items: flex-start; gap: 6px;">
              <span>Precio con descuento</span>
              <input type="number" name="precioDescuento" min="0" step="0.01" placeholder="0.00" />
            </label>

            <label class="filter-option" style="flex-direction: column; align-items: flex-start; gap: 6px;">
              <span>Stock</span>
              <input type="number" name="stock" min="0" step="1" required placeholder="Cantidad disponible" />
            </label>

            <label class="filter-option" style="flex-direction: column; align-items: flex-start; gap: 6px;">
              <span>Fecha de vencimiento</span>
              <input type="date" name="fechaVencimiento" />
            </label>

            <label class="filter-option" style="flex-direction: column; align-items: flex-start; gap: 6px;">
              <span>ID del negocio</span>
              <input type="number" name="idNegocio" min="1" step="1" required placeholder="Ej. 123" />
            </label>
          </div>

          <button type="submit" id="submit-button">Registrar producto</button>
          <div id="form-message" class="meta" role="alert" aria-live="polite"></div>
        </form>
      </section>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("product-form");
      const message = document.getElementById("form-message");
      const submitButton = document.getElementById("submit-button");
      const API_URL = "http://localhost:8084/api/productos";

      function setStatus(text, isError = false) {
        message.textContent = text;
        message.style.color = isError ? "#b00020" : "#0f5132";
      }

      async function handleSubmit(event) {
        event.preventDefault();
        setStatus("");
        submitButton.disabled = true;

        const formData = new FormData(form);
        const payload = {
          nombre: formData.get("nombre")?.trim(),
          categoria: formData.get("categoria") || "",
          descripcion: formData.get("descripcion")?.trim() || "",
          precioOriginal: parseFloat(formData.get("precioOriginal")) || 0,
          precioDescuento: formData.get("precioDescuento") ? parseFloat(formData.get("precioDescuento")) : null,
          stock: parseInt(formData.get("stock"), 10) || 0,
          fechaVencimiento: formData.get("fechaVencimiento") || null,
          idNegocio: parseInt(formData.get("idNegocio"), 10) || null,
        };

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "No se pudo registrar el producto.");
          }

          setStatus("Producto registrado exitosamente. ");
          const backLink = document.createElement("a");
          backLink.href = "index.html";
          backLink.textContent = "Volver al inicio";
          backLink.style.marginLeft = "6px";
          message.appendChild(backLink);
          form.reset();
        } catch (error) {
          setStatus(
            "No pudimos registrar el producto en este momento. Intenta nuevamente.",
            true
          );
        } finally {
          submitButton.disabled = false;
        }
      }

      form.addEventListener("submit", handleSubmit);
    });
  </script>
</body>
</html>
