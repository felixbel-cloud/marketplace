<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marketplace</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">Market</div>
    <nav class="nav-links">
      <a href="producto_nuevo.html">Publicar producto</a>
      <a href="reservas.html">Mis reservas</a>
      <a href="#">Log in</a>
      <a href="#">Register</a>
    </nav>
  </header>

  <main class="main">
    <section class="hero">
      <h1>¡Bienvenido al Marketplace!</h1>
      <p>Explora ofertas en productos cercanos y ahorra en tus compras diarias.</p>
      <div class="search-bar">
        <input type="text" placeholder="Buscar productos o categorías" />
        <button type="button">Buscar</button>
      </div>
      <div class="explore-offers">
        <button type="button" id="explore-offers">Explorar ofertas</button>
      </div>
    </section>

    <section class="layout">
      <aside class="filters">
        <h3>Filtros</h3>
        <label class="filter-option">
          <input type="checkbox" value="Alimentos" />
          <span>Alimentos</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" value="Bebidas" />
          <span>Bebidas</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" value="Lácteos" />
          <span>Lácteos</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" value="Snacks" />
          <span>Snacks</span>
        </label>
      </aside>

      <section class="offers">
        <h2>Ofertas destacadas</h2>
        <div class="offers-list">
        </div>
      </section>
    </section>
  </main>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const offersList = document.querySelector(".offers-list");
      const searchInput = document.querySelector(".search-bar input");
      const searchButton = document.querySelector(".search-bar button");
      const exploreOffersButton = document.querySelector("#explore-offers");
      const categoryCheckboxes = Array.from(
        document.querySelectorAll(".filters input[type='checkbox']")
      );

      const API_BASE_URL = "http://localhost:8084/api";

      let allProducts = [];
      let expiringProducts = [];
      let currentProducts = [];
      let mode = "all";
      const categoryCache = new Map();

      const currencyFormatter = new Intl.NumberFormat("es-PE", {
        style: "currency",
        currency: "PEN",
        minimumFractionDigits: 2,
      });

      function formatPrice(value) {
        if (value === null || value === undefined || Number.isNaN(value)) {
          return "-";
        }
        return currencyFormatter.format(value);
      }

      function expirationLabel(dateString) {
        if (!dateString) return "Sin fecha de vencimiento";
        const today = new Date();
        const target = new Date(`${dateString}T00:00:00`);
        if (Number.isNaN(target.getTime())) return "Sin fecha de vencimiento";
        const diffDays = Math.ceil(
          (target.getTime() - today.setHours(0, 0, 0, 0)) / (1000 * 60 * 60 * 24)
        );
        if (diffDays > 1) return `Vence en ${diffDays} días`;
        if (diffDays === 1) return "Vence en 1 día";
        if (diffDays === 0) return "Vence hoy";
        return "Producto vencido";
      }

      function renderProducts(products) {
        offersList.innerHTML = "";

        if (!products.length) {
          const empty = document.createElement("p");
          empty.className = "meta";
          empty.textContent = "No hay productos disponibles con los filtros actuales.";
          offersList.appendChild(empty);
          return;
        }

        products.forEach((product) => {
          const card = document.createElement("article");
          card.className = "card";

          const info = document.createElement("div");
          const title = document.createElement("div");
          title.className = "title";
          title.textContent = product.nombre || "Producto sin nombre";
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = expirationLabel(product.fechaVencimiento);
          info.appendChild(title);
          info.appendChild(meta);

          const price = document.createElement("div");
          price.className = "price";
          const current = document.createElement("div");
          current.className = "current";
          current.textContent = formatPrice(product.precioDescuento);
          const old = document.createElement("div");
          old.className = "old";
          old.textContent = formatPrice(product.precioOriginal);
          price.appendChild(current);
          price.appendChild(old);

          const button = document.createElement("button");
          button.type = "button";
          button.textContent = "Agregar";

          card.appendChild(info);
          card.appendChild(price);
          card.appendChild(button);
          offersList.appendChild(card);
        });
      }

      function applySearch(products) {
        const term = searchInput.value.trim().toLowerCase();
        if (!term) return products;
        return products.filter((product) =>
          (product.nombre || "").toLowerCase().includes(term)
        );
      }

      function applyFilters() {
        const filtered = applySearch(currentProducts);
        renderProducts(filtered);
      }

      async function fetchProducts() {
        try {
          const response = await fetch(API_BASE_URL + "/productos");
          if (!response.ok) throw new Error("No se pudieron obtener los productos.");
          const data = await response.json();
          allProducts = Array.isArray(data) ? data : [];
          mode = "all";
          currentProducts = allProducts;
          applyFilters();
        } catch (error) {
          offersList.innerHTML = "";
          const message = document.createElement("p");
          message.className = "meta";
          message.textContent = "Ocurrió un problema al cargar los productos.";
          offersList.appendChild(message);
          // Mantener vacío si falla
        }
      }

      async function fetchProductsByCategory(category) {
        if (!category) return [];
        if (categoryCache.has(category)) return categoryCache.get(category);
        try {
          const response = await fetch(
            API_BASE_URL + "/productos/categoria/" + encodeURIComponent(category)
          );
          if (!response.ok) throw new Error();
          const data = await response.json();
          const normalized = Array.isArray(data) ? data : [];
          categoryCache.set(category, normalized);
          return normalized;
        } catch (error) {
          return [];
        }
      }

      async function fetchExpiringProducts() {
        try {
          const response = await fetch(
            API_BASE_URL + "/productos/proximos-vencer?dias=7"
          );
          if (!response.ok) throw new Error();
          const data = await response.json();
          expiringProducts = Array.isArray(data) ? data : [];
          mode = "expiring";
          currentProducts = expiringProducts;
          const hasActiveCategories = categoryCheckboxes.some(
            (checkbox) => checkbox.checked
          );

          if (hasActiveCategories) {
            await updateByCategory();
          } else {
            applyFilters();
          }
        } catch (error) {
          offersList.innerHTML = "";
          const message = document.createElement("p");
          message.className = "meta";
          message.textContent =
            "No fue posible cargar las ofertas próximas a vencer.";
          offersList.appendChild(message);
        }
      }

      async function updateByCategory() {
        const activeCategories = categoryCheckboxes
          .filter((checkbox) => checkbox.checked)
          .map((checkbox) => checkbox.value || checkbox.nextElementSibling?.textContent.trim())
          .filter(Boolean);

        if (!activeCategories.length) {
          currentProducts = mode === "expiring" ? expiringProducts : allProducts;
          applyFilters();
          return;
        }

        if (mode === "expiring") {
          const filtered = expiringProducts.filter((product) => {
            const category = (product.categoria || "").trim();
            return category && activeCategories.includes(category);
          });
          currentProducts = filtered;
          applyFilters();
          return;
        }

        const results = await Promise.all(
          activeCategories.map((category) => fetchProductsByCategory(category))
        );
        const merged = new Map();
        results.flat().forEach((product) => {
          merged.set(product.id || `${product.nombre}-${product.categoria}`, product);
        });
        currentProducts = Array.from(merged.values());
        applyFilters();
      }

      searchInput.addEventListener("input", applyFilters);
      searchButton.addEventListener("click", applyFilters);
      exploreOffersButton.addEventListener("click", fetchExpiringProducts);

      categoryCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener("change", updateByCategory);
      });

      fetchProducts();
    });
  </script>
</body>
</html>
