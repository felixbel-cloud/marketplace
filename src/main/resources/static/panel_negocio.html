<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Negocio</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">Market</div>
    <nav class="nav-links">
      <a href="index.html">Inicio</a>
      <a href="producto_nuevo.html">Publicar producto</a>
      <a href="reservas.html">Mis reservas</a>
      <a href="panel_negocio.html" aria-current="page">Panel negocio</a>
    </nav>
  </header>

  <main class="main">
    <section class="hero">
      <h1>Panel del negocio</h1>
      <p class="meta">Consulta, edita o elimina los productos publicados de tu negocio.</p>
    </section>

    <section class="card block">
      <div class="controls">
        <div class="control-group">
          <label for="business-id">ID de negocio</label>
          <div class="control-inline">
            <input type="number" id="business-id" placeholder="Ingresa el ID de tu negocio" />
            <button type="button" id="load-products">Cargar productos</button>
          </div>
          <p class="hint">Para pruebas rápidas puedes escribir el ID manualmente. Si ya existe en el almacenamiento local, se cargará automáticamente.</p>
        </div>
      </div>
      <div id="status-message" class="status" role="status"></div>
      <div class="table-wrapper">
        <table id="products-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Categoría</th>
              <th>Precio con descuento</th>
              <th>Stock</th>
              <th>Fecha de vencimiento</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card block" id="edit-panel" hidden>
      <h2>Editar producto</h2>
      <form id="edit-form" class="edit-form">
        <div class="form-grid">
          <label>
            Precio con descuento (PEN)
            <input type="number" step="0.01" min="0" id="edit-price" required />
          </label>
          <label>
            Stock
            <input type="number" min="0" id="edit-stock" required />
          </label>
        </div>
        <div class="form-actions">
          <button type="submit" class="primary">Guardar cambios</button>
          <button type="button" id="cancel-edit" class="ghost">Cancelar</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const API_BASE_URL = "http://localhost:8084/api";

      const businessInput = document.getElementById("business-id");
      const loadButton = document.getElementById("load-products");
      const statusMessage = document.getElementById("status-message");
      const tableBody = document.querySelector("#products-table tbody");
      const editPanel = document.getElementById("edit-panel");
      const editForm = document.getElementById("edit-form");
      const editPrice = document.getElementById("edit-price");
      const editStock = document.getElementById("edit-stock");
      const cancelEdit = document.getElementById("cancel-edit");

      let currentBusinessId = null;
      let products = [];
      let editingProduct = null;

      function setStatus(message, type = "info") {
        statusMessage.textContent = message;
        statusMessage.className = `status ${type}`;
      }

      function formatCurrency(value) {
        if (value === null || value === undefined || Number.isNaN(value)) return "-";
        return new Intl.NumberFormat("es-PE", {
          style: "currency",
          currency: "PEN",
          minimumFractionDigits: 2,
        }).format(value);
      }

      function formatDate(value) {
        if (!value) return "Sin fecha";
        try {
          const date = new Date(`${value}T00:00:00`);
          if (Number.isNaN(date.getTime())) return "Sin fecha";
          return date.toLocaleDateString("es-PE", { year: "numeric", month: "short", day: "numeric" });
        } catch (error) {
          return "Sin fecha";
        }
      }

      function renderTable(data) {
        tableBody.innerHTML = "";

        if (!data.length) {
          const emptyRow = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 6;
          cell.className = "empty";
          cell.textContent = "No hay productos para este negocio.";
          emptyRow.appendChild(cell);
          tableBody.appendChild(emptyRow);
          return;
        }

        data.forEach((product) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <div class="title">${product.nombre || "Sin nombre"}</div>
              <div class="meta">ID: ${product.id ?? "-"}</div>
            </td>
            <td><span class="pill">${product.categoria || "-"}</span></td>
            <td>${formatCurrency(product.precioDescuento)}</td>
            <td>${product.stock ?? "-"}</td>
            <td>${formatDate(product.fechaVencimiento)}</td>
            <td class="actions">
              <button type="button" class="action-button edit" data-id="${product.id}">Editar</button>
              <button type="button" class="action-button delete" data-id="${product.id}">Eliminar</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      async function loadProducts(businessId) {
        if (!businessId) {
          setStatus("Ingresa un ID de negocio para continuar", "warning");
          return;
        }
        try {
          setStatus("Cargando productos...", "info");
          const response = await fetch(`${API_BASE_URL}/productos/negocio/${businessId}`);
          if (!response.ok) {
            throw new Error("No se pudieron obtener los productos");
          }
          products = await response.json();
          renderTable(products);
          setStatus(`Productos cargados para el negocio ${businessId}`, "success");
        } catch (error) {
          renderTable([]);
          setStatus(error.message || "Error al cargar productos", "error");
        }
      }

      function persistBusinessId(value) {
        localStorage.setItem("idNegocioActual", value);
      }

      function restoreBusinessId() {
        const stored = localStorage.getItem("idNegocioActual");
        if (stored) {
          businessInput.value = stored;
          currentBusinessId = stored;
          loadProducts(stored);
        }
      }

      function startEdit(productId) {
        const product = products.find((item) => String(item.id) === String(productId));
        if (!product) return;
        editingProduct = product;
        editPrice.value = product.precioDescuento ?? "";
        editStock.value = product.stock ?? "";
        editPanel.hidden = false;
        editPanel.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function resetEdit() {
        editingProduct = null;
        editForm.reset();
        editPanel.hidden = true;
      }

      async function deleteProduct(productId) {
        if (!confirm("¿Eliminar este producto?")) return;
        try {
          setStatus("Eliminando producto...", "info");
          const response = await fetch(`${API_BASE_URL}/productos/${productId}`, {
            method: "DELETE",
          });
          if (!response.ok) throw new Error("No se pudo eliminar el producto");
          setStatus("Producto eliminado", "success");
          await loadProducts(currentBusinessId);
          resetEdit();
        } catch (error) {
          setStatus(error.message || "Error al eliminar el producto", "error");
        }
      }

      async function submitEdit(event) {
        event.preventDefault();
        if (!editingProduct) return;

        const precioDescuento = Number.parseFloat(editPrice.value);
        const stock = Number.parseInt(editStock.value, 10);
        if (Number.isNaN(precioDescuento) || Number.isNaN(stock)) {
          setStatus("Completa el formulario para continuar", "warning");
          return;
        }

        const payload = {
          nombre: editingProduct.nombre,
          categoria: editingProduct.categoria,
          descripcion: editingProduct.descripcion,
          precioOriginal: editingProduct.precioOriginal,
          precioDescuento,
          stock,
          fechaVencimiento: editingProduct.fechaVencimiento,
          negocioId: editingProduct.negocio?.id ?? currentBusinessId,
        };

        try {
          setStatus("Guardando cambios...", "info");
          const response = await fetch(`${API_BASE_URL}/productos/${editingProduct.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) throw new Error("No se pudo actualizar el producto");
          setStatus("Producto actualizado", "success");
          resetEdit();
          await loadProducts(currentBusinessId);
        } catch (error) {
          setStatus(error.message || "Error al actualizar el producto", "error");
        }
      }

      loadButton.addEventListener("click", () => {
        const value = businessInput.value.trim();
        currentBusinessId = value;
        if (value) persistBusinessId(value);
        loadProducts(value);
      });

      tableBody.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const productId = target.dataset.id;
        if (!productId) return;

        if (target.classList.contains("edit")) {
          startEdit(productId);
        }
        if (target.classList.contains("delete")) {
          deleteProduct(productId);
        }
      });

      editForm.addEventListener("submit", submitEdit);
      cancelEdit.addEventListener("click", resetEdit);

      restoreBusinessId();
    });
  </script>
</body>
</html>
